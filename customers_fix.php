<?php

require_once 'app/Mage.php';
Mage::app();
Mage::app()->setCurrentStore(Mage_Core_Model_App::ADMIN_STORE_ID);

// import date: 2015-09-25 00:33:21
// 80,000 date: 2015-09-30 20:19:56

// $customerIdsToBeDeleted = Mage::getResourceModel('customer/customer_collection')
// 	->addAttributeToFilter('created_at', array('gt' => '2015-09-25 00:33:21'))
// 	->addAttributeToFilter('created_at', array('lteq' => '2015-09-30 20:19:56'))
// 	->getAllIds();

// $select = Mage::getResourceModel('customer/customer_collection')
// 	->addAttributeToFilter('created_at', array('gt' => '2015-09-25 00:33:21'))
// 	->addAttributeToFilter('created_at', array('lteq' => '2015-09-30 20:19:57'))
// 	->getSelect();

// echo $select . PHP_EOL;
// exit;

$customerIdsToBeDeleted = array(
  0 => '70268',
  1 => '70269',
  2 => '70270',
  3 => '70271',
  4 => '70272',
  5 => '70273',
  6 => '70274',
  7 => '70275',
  8 => '70276',
  9 => '70277',
  10 => '70278',
  11 => '70279',
  12 => '70280',
  13 => '70281',
  14 => '70282',
  15 => '70283',
  16 => '70284',
  17 => '70285',
  18 => '70286',
  19 => '70287',
  20 => '70288',
  21 => '70289',
  22 => '70290',
  23 => '70291',
  24 => '70292',
  25 => '70293',
  26 => '70294',
  27 => '70295',
  28 => '70296',
  29 => '70297',
  30 => '70298',
  31 => '70299',
  32 => '70300',
  33 => '70301',
  34 => '70302',
  35 => '70303',
  36 => '70304',
  37 => '70305',
  38 => '70306',
  39 => '70307',
  40 => '70308',
  41 => '70309',
  42 => '70310',
  43 => '70311',
  44 => '70312',
  45 => '70313',
  46 => '70314',
  47 => '70315',
  48 => '70316',
  49 => '70317',
  50 => '70318',
  51 => '70319',
  52 => '70320',
  53 => '70321',
  54 => '70322',
  55 => '70323',
  56 => '70324',
  57 => '70325',
  58 => '70326',
  59 => '70327',
  60 => '70328',
  61 => '70329',
  62 => '70330',
  63 => '70331',
  64 => '70332',
  65 => '70333',
  66 => '70334',
  67 => '70335',
  68 => '70336',
  69 => '70337',
  70 => '70338',
  71 => '70339',
  72 => '70340',
  73 => '70341',
  74 => '70342',
  75 => '70343',
  76 => '70344',
  77 => '70345',
  78 => '70346',
  79 => '70347',
  80 => '70348',
  81 => '70349',
  82 => '70350',
  83 => '70351',
  84 => '70352',
  85 => '70353',
  86 => '70354',
  87 => '70355',
  88 => '70356',
  89 => '70357',
  90 => '70358',
  91 => '70359',
  92 => '70360',
  93 => '70361',
  94 => '70362',
  95 => '70363',
  96 => '70364',
  97 => '70365',
  98 => '70366',
  99 => '70367',
  100 => '70368',
  101 => '70369',
  102 => '70370',
  103 => '70371',
  104 => '70372',
  105 => '70373',
  106 => '70374',
  107 => '70375',
  108 => '70376',
  109 => '70377',
  110 => '70378',
  111 => '70379',
  112 => '70380',
  113 => '70381',
  114 => '70382',
  115 => '70383',
  116 => '70384',
  117 => '70385',
  118 => '70386',
  119 => '70387',
  120 => '70388',
  121 => '70389',
  122 => '70390',
  123 => '70391',
  124 => '70392',
  125 => '70393',
  126 => '70394',
  127 => '70395',
  128 => '70396',
  129 => '70397',
  130 => '70398',
  131 => '70399',
  132 => '70400',
  133 => '70401',
  134 => '70402',
  135 => '70403',
  136 => '70404',
  137 => '70405',
  138 => '70406',
  139 => '70407',
  140 => '70408',
  141 => '70409',
  142 => '70410',
  143 => '70411',
  144 => '70412',
  145 => '70413',
  146 => '70414',
  147 => '70415',
  148 => '70416',
  149 => '70417',
  150 => '70418',
  151 => '70419',
  152 => '70420',
  153 => '70421',
  154 => '70422',
  155 => '70423',
  156 => '70424',
  157 => '70425',
  158 => '70426',
  159 => '70427',
  160 => '70428',
  161 => '70429',
  162 => '70430',
  163 => '70431',
  164 => '70432',
  165 => '70433',
  166 => '70434',
  167 => '70435',
  168 => '70436',
  169 => '70437',
  170 => '70438',
  171 => '70439',
  172 => '70440',
  173 => '70441',
  174 => '70442',
  175 => '70443',
  176 => '70444',
  177 => '70445',
  178 => '70446',
  179 => '70447',
  180 => '70448',
  181 => '70449',
  182 => '70450',
  183 => '70451',
  184 => '70452',
  185 => '70453',
  186 => '70454',
  187 => '70455',
  188 => '70456',
  189 => '70457',
  190 => '70458',
  191 => '70459',
  192 => '70460',
  193 => '70461',
  194 => '70462',
  195 => '70463',
  196 => '70464',
  197 => '70465',
  198 => '70466',
  199 => '70467',
  200 => '70468',
  201 => '70469',
  202 => '70470',
  203 => '70471',
  204 => '70472',
  205 => '70473',
  206 => '70474',
  207 => '70475',
  208 => '70476',
  209 => '70477',
  210 => '70478',
  211 => '70479',
  212 => '70480',
  213 => '70481',
  214 => '70482',
  215 => '70483',
  216 => '70484',
  217 => '70485',
  218 => '70486',
  219 => '70487',
  220 => '70488',
  221 => '70489',
  222 => '70490',
  223 => '70491',
  224 => '70492',
  225 => '70493',
  226 => '70494',
  227 => '70495',
  228 => '70496',
  229 => '70497',
  230 => '70498',
  231 => '70499',
  232 => '70500',
  233 => '70501',
  234 => '70502',
  235 => '70503',
  236 => '70504',
  237 => '70505',
  238 => '70506',
  239 => '70507',
  240 => '70508',
  241 => '70509',
  242 => '70510',
  243 => '70511',
  244 => '70512',
  245 => '70513',
  246 => '70514',
  247 => '70515',
  248 => '70516',
  249 => '70517',
  250 => '70518',
  251 => '70519',
  252 => '70520',
  253 => '70521',
  254 => '70522',
  255 => '70523',
  256 => '70524',
  257 => '70525',
  258 => '70526',
  259 => '70527',
  260 => '70528',
  261 => '70529',
  262 => '70530',
  263 => '70531',
  264 => '70532',
  265 => '70533',
  266 => '70534',
  267 => '70535',
  268 => '70536',
  269 => '70537',
  270 => '70538',
  271 => '70539',
  272 => '70540',
  273 => '70541',
  274 => '70542',
  275 => '70543',
  276 => '70544',
  277 => '70545',
  278 => '70546',
  279 => '70547',
  280 => '70548',
  281 => '70549',
  282 => '70550',
  283 => '70551',
  284 => '70552',
  285 => '70553',
  286 => '70554',
  287 => '70555',
  288 => '70556',
  289 => '70557',
  290 => '70558',
  291 => '70559',
  292 => '70560',
  293 => '70561',
  294 => '70562',
  295 => '70563',
  296 => '70564',
  297 => '70565',
  298 => '70566',
  299 => '70567',
  300 => '70568',
  301 => '70569',
  302 => '70570',
  303 => '70571',
  304 => '70572',
  305 => '70573',
  306 => '70574',
  307 => '70575',
  308 => '70576',
  309 => '70577',
  310 => '70578',
  311 => '70579',
  312 => '70580',
  313 => '70581',
  314 => '70582',
  315 => '70583',
  316 => '70584',
  317 => '70585',
  318 => '70586',
  319 => '70587',
  320 => '70588',
  321 => '70589',
  322 => '70590',
  323 => '70591',
  324 => '70592',
  325 => '70593',
  326 => '70594',
  327 => '70595',
  328 => '70596',
  329 => '70597',
  330 => '70598',
  331 => '70599',
  332 => '70600',
  333 => '70601',
  334 => '70602',
  335 => '70603',
  336 => '70604',
  337 => '70605',
  338 => '70606',
  339 => '70607',
  340 => '70608',
  341 => '70609',
  342 => '70610',
  343 => '70611',
  344 => '70612',
  345 => '70613',
  346 => '70614',
  347 => '70615',
  348 => '70616',
  349 => '70617',
  350 => '70618',
  351 => '70619',
  352 => '70620',
  353 => '70621',
  354 => '70622',
  355 => '70623',
  356 => '70624',
  357 => '70625',
  358 => '70626',
  359 => '70627',
  360 => '70628',
  361 => '70629',
  362 => '70630',
  363 => '70631',
  364 => '70632',
  365 => '70633',
  366 => '70634',
  367 => '70635',
  368 => '70636',
  369 => '70637',
  370 => '70638',
);


//$customerIdsToBeDeleted = array(70637);


// echo count($customerIdsToBeDeleted) . PHP_EOL;
// exit;

foreach ($customerIdsToBeDeleted as $customerIdToBeDeleted) {
	$customerToBeDeleted = Mage::getModel('customer/customer')->load($customerIdToBeDeleted);
	if (!$customerToBeDeleted) {
		continue; // error
	}

	// CUSTOMERS


	$newCustomer = Mage::getModel('customer/customer');
	$newCustomer->addData($customerToBeDeleted->getData());

	$customerToBeDeleted->setEmail('asdf'.microtime().'@asdf.com');


	try {
			$customerToBeDeleted->save();
	} catch (Exception $e) {
		echo $e->getMessage() . PHP_EOL;
	}


	$newCustomer->setId(null);

	try {
		$newCustomer->save();
		echo 'new customer: ' . $newCustomer->getId() . "   old customer: ".$customerToBeDeleted->getId().PHP_EOL;
	} catch (Exception $e) {
		echo $e->getMessage() . PHP_EOL;
	}

	// ADDRESSES

	$customerToBeDeletedAddresses = $customerToBeDeleted->getAddresses();
	foreach ($customerToBeDeletedAddresses as $customerToBeDeletedAddress) {
		$newAddress = Mage::getModel('customer/address');

		$newAddress->addData($customerToBeDeletedAddress->getData());
		
		$newAddress->setId(null);
		$newAddress->setCustomerId($newCustomer->getId());

		try {
			$newAddress->save();
			echo 'new customer address: ' . $newAddress->getId() . PHP_EOL;
		} catch (Exception $e) {
			echo $e->getMessage() . PHP_EOL;
		}

		$newCustomer->setDefaultBilling($newAddress->getId());
		$newCustomer->setDefaultShipping($newAddress->getId());

		try {
			$newCustomer->save();
		} catch (Exception $e) {
			echo $e->getMessage() . PHP_EOL;
		}

		try {
			$customerToBeDeletedAddress->delete();
		} catch (Exception $e) {
			echo $e->getMessage() . PHP_EOL;
		}
		
	}

	// ORDERS

	$customerToBeDeletedOrderIds = Mage::getResourceModel('sales/order_collection')
		->addAttributeToFilter('customer_id', array('eq' => $customerToBeDeleted->getId()))
		->getAllIds();

	foreach ($customerToBeDeletedOrderIds as $customerToBeDeletedOrderId) {


		$orderToBeDeleted = Mage::getModel('sales/order')->load($customerToBeDeletedOrderId);
		if (!$orderToBeDeleted) {
			continue; // error
		}

		if($orderToBeDeleted->getCustomerEmail() != $newCustomer->getEmail()) {
			try {
				$orderToBeDeleted->delete();
			} catch (Exception $e) {
				echo $e->getMessage() . PHP_EOL;
			}
		}

	}

	try {
		$customerToBeDeleted->delete();
	} catch (Exception $e) {
		echo $e->getMessage() . PHP_EOL;
	}
}
